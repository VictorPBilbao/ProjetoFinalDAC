<!-- Loading State -->
<div *ngIf="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Carregando dados do cliente...</p>
</div>

<!-- Error State -->
<div *ngIf="error && !loading" class="error-container">
    <div class="error-message">
        <h3>Erro</h3>
        <p>{{ error }}</p>
        <button type="button" class="btn-retry" (click)="loadUserData()">
            Tentar novamente
        </button>
    </div>
</div>

<!-- Main Content -->
<div class="user-details-wrapper" *ngIf="cliente && !loading && !error">
    <div class="header">
        <h2>Perfil do Cliente</h2>
        <div class="status" *ngIf="saved">Altera√ß√µes salvas!</div>
    </div>

    <div class="account-summary">
        <div class="item">
            <span class="label">Ag√™ncia</span>
            <span class="value">{{ cliente.agencia }}</span>
        </div>
        <div class="item">
            <span class="label">Conta</span>
            <span class="value">{{ cliente.conta }}</span>
        </div>
        <div class="item">
            <span class="label">Saldo</span>
            <span class="value" [class.negative]="cliente.saldo < 0">
                {{ cliente.saldo | currency : "BRL" : "symbol" : "1.2-2" }}
            </span>
        </div>
        <div class="item">
            <span class="label">Limite</span>
            <span class="value">{{
                cliente.limite | currency : "BRL" : "symbol" : "1.2-2"
            }}</span>
        </div>
        <div class="item">
            <span class="label">Gerente</span>
            <span class="value">{{ cliente.manager.name }}</span>
        </div>
    </div>

    <form [formGroup]="form" (ngSubmit)="salvar()" novalidate>
        <section class="section">
            <h3>Dados Pessoais</h3>
            <div class="grid">
                <div class="form-field">
                    <label for="nome">Nome</label>
                    <input
                        id="nome"
                        type="text"
                        formControlName="nome"
                        placeholder="Nome"
                        [readonly]="!editMode"
                    />
                    <small
                        *ngIf="
                            form.get('nome')?.invalid &&
                            form.get('nome')?.touched
                        "
                        >Nome obrigat√≥rio (m√≠n. 3)</small
                    >
                </div>
                <div class="form-field">
                    <label for="email">E-mail</label>
                    <input
                        id="email"
                        type="email"
                        formControlName="email"
                        placeholder="email@exemplo.com"
                        readonly
                    />
                </div>
                <div class="form-field">
                    <label for="cpf">CPF</label>
                    <input
                        id="cpf"
                        type="text"
                        formControlName="cpf"
                        placeholder="CPF"
                        readonly
                    />
                </div>
                <div class="form-field">
                    <label for="telefone">Telefone</label>
                    <input
                        id="telefone"
                        type="text"
                        formControlName="telefone"
                        placeholder="(00) 00000-0000"
                        [readonly]="!editMode"
                    />
                </div>
                <div class="form-field">
                    <label for="salario">Sal√°rio</label>
                    <input
                        id="salario"
                        type="number"
                        formControlName="salario"
                        step="0.01"
                        placeholder="Sal√°rio"
                        [readonly]="!editMode"
                    />
                </div>
            </div>
        </section>

        <section class="section">
            <h3>Endere√ßo</h3>
            <div formGroupName="endereco" class="grid">
                <!-- CEP Field with Auto-fill -->
                <div class="form-field small cep-field">
                    <label for="cep">CEP</label>
                    <div class="input-with-icon">
                        <input
                            id="cep"
                            type="text"
                            formControlName="cep"
                            placeholder="00000-000"
                            [readonly]="!editMode"
                            (blur)="onCepBlur()"
                            (input)="onCepInput($event)"
                            maxlength="9"
                        />
                        <div *ngIf="loadingCep" class="cep-loading">üîÑ</div>
                    </div>
                    <small *ngIf="cepError" class="error-text">{{
                        cepError
                    }}</small>
                    <small *ngIf="editMode" class="help-text"
                        >Digite o CEP para preencher automaticamente o
                        endere√ßo</small
                    >
                </div>

                <!-- Auto-filled fields (readonly) -->
                <div class="form-field">
                    <label for="logradouro">Logradouro</label>
                    <input
                        id="logradouro"
                        type="text"
                        formControlName="logradouro"
                        placeholder="Ser√° preenchido pelo CEP"
                        readonly
                        class="auto-fill"
                    />
                </div>

                <div class="form-field">
                    <label for="bairro">Bairro</label>
                    <input
                        id="bairro"
                        type="text"
                        formControlName="bairro"
                        placeholder="Ser√° preenchido pelo CEP"
                        readonly
                        class="auto-fill"
                    />
                </div>

                <div class="form-field">
                    <label for="cidade">Cidade</label>
                    <input
                        id="cidade"
                        type="text"
                        formControlName="cidade"
                        placeholder="Ser√° preenchida pelo CEP"
                        readonly
                        class="auto-fill"
                    />
                </div>

                <div class="form-field tiny">
                    <label for="estado">Estado</label>
                    <input
                        id="estado"
                        type="text"
                        maxlength="2"
                        formControlName="estado"
                        placeholder="UF"
                        readonly
                        class="auto-fill"
                    />
                </div>

                <!-- Editable fields -->
                <div class="form-field small">
                    <label for="numero">N√∫mero *</label>
                    <input
                        id="numero"
                        type="text"
                        formControlName="numero"
                        placeholder="N√∫mero"
                        [readonly]="!editMode"
                    />
                    <small
                        *ngIf="
                            enderecoGroup.get('numero')?.invalid &&
                            enderecoGroup.get('numero')?.touched
                        "
                        class="error-text"
                    >
                        N√∫mero √© obrigat√≥rio
                    </small>
                </div>

                <div class="form-field">
                    <label for="complemento">Complemento</label>
                    <input
                        id="complemento"
                        type="text"
                        formControlName="complemento"
                        placeholder="Complemento (opcional)"
                        [readonly]="!editMode"
                    />
                </div>

                <!-- Hidden tipo field -->
                <input type="hidden" formControlName="tipo" />
            </div>
        </section>

        <div class="actions">
            <button
                type="button"
                class="btn-outline"
                (click)="toggleEdit()"
                *ngIf="!editMode"
            >
                Editar
            </button>
            <button
                type="button"
                class="btn-text"
                (click)="toggleEdit()"
                *ngIf="editMode"
            >
                Cancelar
            </button>
            <button type="submit" class="btn-primary" *ngIf="editMode">
                Salvar
            </button>
        </div>
    </form>

    <div class="preview" *ngIf="saved">
        <h4>Resumo Atualizado</h4>
        <pre>{{ cliente | json }}</pre>
    </div>
</div>
